# AgroCulture - Система управления бронированием домиков

Курсовой проект - WPF приложение для управления бронированием домиков в агротуристическом комплексе.

## Описание проекта

**AgroCulture** - это настольное приложение на C# WPF для управления бронированием домиков. Система поддерживает различные роли пользователей (Администратор, Менеджер, Гость) и предоставляет полный функционал для управления объектами размещения, персоналом и бронированиями.

## Технологии

- **Платформа:** .NET Framework 4.7+
- **UI:** WPF (Windows Presentation Foundation)
- **База данных:** Microsoft SQL Server
- **ORM:** Entity Framework 6.5
- **UI библиотека:** MaterialDesignThemes
- **Экспорт данных:** EPPlus (Excel), iTextSharp (PDF)
- **Безопасность:** SHA256 хеширование паролей

## Основной функционал

### Роли пользователей

#### 1. Администратор (Admin)
- Управление домиками (добавление, редактирование, удаление)
- Управление персоналом (создание, редактирование пользователей)
- Управление бронированиями
- Просмотр статистики
- Экспорт данных в Excel/PDF
- Полный доступ ко всем функциям

#### 2. Менеджер (Manager)
- Управление бронированиями (создание, редактирование, отмена)
- Просмотр списка бронирований
- Экспорт данных в Excel/PDF
- Управление профилем

#### 3. Гость (Guest)
- Просмотр каталога доступных домиков
- Просмотр своих бронирований
- Ограниченный функционал

### Функциональные модули

#### Управление домиками (Cabins Management)
- Добавление новых домиков
- Редактирование информации о домиках
- Управление удобствами (amenities)
- Установка цены за ночь
- Указание максимальной вместимости
- Мягкое удаление (IsActive флаг)

#### Управление бронированиями (Bookings)
- Создание бронирований с проверкой доступности
- Автоматический расчет стоимости
- Редактирование бронирований
- Отмена бронирований
- Фильтрация по статусу (активные/завершенные)
- Поиск по гостю, телефону, названию домика
- Статистика: всего бронирований, активные, завершенные, общая выручка

#### Управление сотрудниками (Staff Management)
- Создание новых пользователей
- Назначение ролей
- Редактирование контактной информации
- Мягкое удаление пользователей
- Защита от самоудаления

#### Профиль пользователя (Profile)
- Просмотр личной информации
- Редактирование ФИО
- Редактирование телефона и email
- Смена пароля
- Статистика по роли

#### Экспорт данных
- **Excel:** Детальный отчет по бронированиям с форматированием
- **PDF:** Табличный отчет со статистикой

## Безопасность

### Хеширование паролей (SHA256)
В последней версии реализовано безопасное хранение паролей:
- Все пароли хешируются с использованием SHA256
- Пароли никогда не хранятся в открытом виде
- При проверке используется сравнение хешей

**Для обновления существующей БД:** см. файл `ОБНОВЛЕНИЕ_БД.md`

### Валидация данных

#### Валидация телефонов (RegEx)
Поддерживаемые форматы:
- `+7 (999) 999-99-99`
- `+79999999999`
- `89999999999`
- `79999999999`

#### Валидация Email
Стандартная проверка формата email-адреса

#### Валидация дат
- Дата заезда не может быть в прошлом
- Дата выезда должна быть позже даты заезда
- Проверка конфликтов бронирований

## Установка и запуск

### Требования
- Windows 10/11
- .NET Framework 4.7 или выше
- Microsoft SQL Server 2016+ (или SQL Server Express)
- Visual Studio 2019/2022 (для разработки)

### Установка

1. **Клонирование репозитория:**
```bash
git clone <repository-url>
cd AgroCultureIS
```

2. **Создание базы данных:**
```sql
-- Выполните скрипт AAAAAAA.sql в SQL Server Management Studio
```

3. **Обновление строки подключения:**
Откройте `App.config` и обновите строку подключения:
```xml
<connectionStrings>
  <add name="AgroCultureEntities"
       connectionString="..."
       providerName="System.Data.EntityClient" />
</connectionStrings>
```

4. **Обновление паролей (для безопасности):**
```sql
-- Выполните скрипт update_passwords.sql
```

5. **Сборка проекта:**
```bash
# В Visual Studio
Build -> Build Solution (Ctrl+Shift+B)
```

6. **Запуск:**
```bash
# В Visual Studio
Debug -> Start Debugging (F5)
```

## Тестовые учетные записи

После установки БД и выполнения `update_passwords.sql`:

| Роль | Логин | Пароль |
|------|-------|---------|
| Администратор | admin | admin |
| Менеджер | manager | manager |
| Гость | guest | guest |

## Структура проекта

```
AgroCultureIS/
│
├── AgroCulture/
│   ├── ViewModels/           # ViewModels для MVVM паттерна
│   │   ├── BaseViewModel.cs
│   │   ├── CabinsManagementViewModel.cs
│   │   ├── CabinBookingViewModel.cs
│   │   ├── BookingsListViewModel.cs
│   │   └── StaffViewModel.cs
│   │
│   ├── Views/                # View (XAML + Code-behind)
│   │   ├── CabinsManagementView.xaml
│   │   ├── CabinBookingView.xaml
│   │   ├── BookingsListView.xaml
│   │   ├── StaffManagementView.xaml
│   │   ├── ProfilePage.xaml
│   │   └── *EditWindow.xaml
│   │
│   ├── Services/             # Бизнес-логика и утилиты
│   │   ├── DatabaseService.cs
│   │   ├── PasswordHasher.cs (SHA256)
│   │   ├── PhoneValidator.cs (RegEx)
│   │   └── NameParser.cs
│   │
│   ├── Converters/           # Value converters для XAML
│   ├── Resources/            # Ресурсы (стили, изображения)
│   │
│   ├── Model.edmx            # Entity Framework модель
│   ├── MainWindow.xaml       # Главное окно приложения
│   ├── LoginWindow.xaml      # Окно авторизации
│   └── App.config            # Конфигурация приложения
│
├── AAAAAAA.sql               # Скрипт создания базы данных
├── update_passwords.sql      # Скрипт обновления паролей (SHA256)
├── README.md                 # Этот файл
└── ОБНОВЛЕНИЕ_БД.md          # Инструкция по обновлению БД
```

## Выполненные исправления и улучшения

### Критические исправления

1. **SHA256 хеширование паролей**
   - Заменено хранение паролей в открытом виде на SHA256 хеши
   - Файлы: `Services/PasswordHasher.cs`, `DatabaseService.cs`, `StaffViewModel.cs`, `ProfilePage.xaml.cs`

2. **Добавлен отсутствующий метод UpdateUserDisplay()**
   - Исправлена ошибка вызова несуществующего метода
   - Файл: `MainWindow.xaml.cs:227`

3. **Исправлен NullReferenceException в ProfilePage**
   - Добавлена проверка на пустую фамилию перед Substring()
   - Файл: `ProfilePage.xaml.cs:76, 218`

### Важные улучшения

4. **Валидация формата телефона (RegEx)**
   - Создан `PhoneValidator.cs` с регулярными выражениями
   - Добавлена валидация в `CabinBookingViewModel` и `StaffViewModel`

5. **Защита от null reference в BookingEditWindow**
   - Добавлены проверки на null для `booking` и `_currentCabin`
   - Файл: `BookingEditWindow.xaml.cs:49-66`

### Дополнительные улучшения

- Улучшена обработка ошибок
- Добавлена валидация email (опциональная)
- Реализована защита от самоудаления пользователя
- Добавлена проверка активных бронирований при удалении домика

## Известные ограничения

1. **Нет многопользовательской синхронизации**
   - При одновременной работе нескольких пользователей возможны race conditions

2. **Нет истории изменений**
   - Не ведется аудит действий пользователей

3. **Простое хеширование паролей**
   - Используется SHA256 без salt (для production рекомендуется bcrypt или Argon2)

4. **Нет загрузки изображений домиков**
   - В БД предусмотрено поле ImageUrl, но функционал не реализован

## Планы развития

- [ ] Добавить календарный вид для бронирований
- [ ] Реализовать загрузку фотографий домиков
- [ ] Добавить email-уведомления
- [ ] Внедрить систему отзывов и оценок
- [ ] Реализовать финансовые отчеты
- [ ] Добавить резервное копирование БД из интерфейса
- [ ] Реализовать многопользовательскую синхронизацию

## Лицензия

Курсовой проект для образовательных целей.

## Контакты

При возникновении вопросов обращайтесь к разработчикам проекта.

---

**Версия:** 2.0
**Дата последнего обновления:** 2025-11-10
