<UserControl x:Class="AgroCulture.Views.CabinBookingView"
             xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:materialDesign="http://materialdesigninxaml.net/winfx/xaml/themes"
             xmlns:viewmodels="clr-namespace:AgroCulture.ViewModels"
             xmlns:converters="clr-namespace:AgroCulture.Converters"
             Background="Transparent"
             UseLayoutRounding="True"
             SnapsToDevicePixels="True">

    <UserControl.DataContext>
        <viewmodels:CabinBookingViewModel/>
    </UserControl.DataContext>

    <UserControl.Resources>
        <!-- Конвертеры -->
        <converters:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <converters:InverseBoolToVisibilityConverter x:Key="InverseBoolToVisibilityConverter"/>
        <converters:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>

        <!-- Градиент -->
        <LinearGradientBrush x:Key="PrimaryGradient" StartPoint="0,0.5" EndPoint="1,0.5">
            <GradientStop Color="#15803D" Offset="0"/>
            <GradientStop Color="#059669" Offset="1"/>
        </LinearGradientBrush>
    </UserControl.Resources>

    <Grid Margin="16">
        <Grid.ColumnDefinitions>
            <!-- Левая колонка: Каталог (2/3) -->
            <ColumnDefinition Width="2*" MinWidth="600"/>
            <ColumnDefinition Width="16"/>
            <!-- Правая колонка: Форма (1/3) -->
            <ColumnDefinition Width="*" MinWidth="350" MaxWidth="450"/>
        </Grid.ColumnDefinitions>

        <!-- ═══════════════════════════════════════════════════════════ -->
        <!-- ЛЕВАЯ КОЛОНКА: КАТАЛОГ ДОМИКОВ -->
        <!-- ═══════════════════════════════════════════════════════════ -->
        <materialDesign:Card Grid.Column="0"
                            UniformCornerRadius="8"
                            materialDesign:ElevationAssist.Elevation="Dp4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок -->
                <Border Grid.Row="0" Height="64" CornerRadius="8,8,0,0">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0.5" EndPoint="1,0.5">
                            <GradientStop Color="#2E7D32" Offset="0"/>
                            <GradientStop Color="#00897B" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>

                    <StackPanel Orientation="Horizontal" 
                               VerticalAlignment="Center"
                               Margin="24,0">
                        <materialDesign:PackIcon Kind="Home" 
                                                Width="20" Height="20"
                                                Foreground="White"
                                                VerticalAlignment="Center"
                                                Margin="0,0,12,0"/>
                        <TextBlock Text="Доступные домики" 
                                  FontSize="20"
                                  FontWeight="Medium"
                                  Foreground="White"
                                  VerticalAlignment="Center"/>
                    </StackPanel>
                </Border>

                <!-- Сетка домиков -->
                <ScrollViewer Grid.Row="1" 
                             VerticalScrollBarVisibility="Auto"
                             Padding="16">
                    <ItemsControl ItemsSource="{Binding Cabins}">
                        <ItemsControl.ItemsPanel>
                            <ItemsPanelTemplate>
                                <UniformGrid Columns="2" 
                                           HorizontalAlignment="Stretch"/>
                            </ItemsPanelTemplate>
                        </ItemsControl.ItemsPanel>

                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <!-- Карточка домика -->
                                <Border x:Name="CabinCard"
                                       Background="White"
                                       BorderBrush="#E5E7EB"
                                       BorderThickness="2"
                                       CornerRadius="12"
                                       Padding="16"
                                       Margin="6"
                                       Cursor="Hand">
                                    <Border.InputBindings>
                                        <MouseBinding MouseAction="LeftClick"
                                                     Command="{Binding DataContext.SelectCabinCommand, RelativeSource={RelativeSource AncestorType=UserControl}}"
                                                     CommandParameter="{Binding}"/>
                                    </Border.InputBindings>

                                    <Grid>
                                        <Grid.RowDefinitions>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                            <RowDefinition Height="Auto"/>
                                        </Grid.RowDefinitions>

                                        <!-- Header: Название + Badge "Выбран" -->
                                        <Grid Grid.Row="0" Margin="0,0,0,12">
                                            <TextBlock Text="{Binding Name}"
                                                      FontSize="16"
                                                      FontWeight="SemiBold"
                                                      Foreground="#1F2937"
                                                      VerticalAlignment="Center"/>

                                            <Border x:Name="SelectedBadge"
                                                   Background="#15803D"
                                                   CornerRadius="12"
                                                   Padding="8,4"
                                                   HorizontalAlignment="Right"
                                                   Visibility="Collapsed">
                                                <TextBlock Text="Выбран"
                                                          FontSize="12"
                                                          FontWeight="Medium"
                                                          Foreground="White"/>
                                            </Border>
                                        </Grid>

                                        <!-- Описание -->
                                        <TextBlock Grid.Row="1"
                                                  Text="{Binding Description}"
                                                  FontSize="14"
                                                  Foreground="#6B7280"
                                                  TextWrapping="Wrap"
                                                  Margin="0,0,0,12"/>

                                        <!-- Инфо: Вместимость + Цена -->
                                        <StackPanel Grid.Row="2" 
                                                   Orientation="Horizontal"
                                                   Margin="0,0,0,12">
                                            <!-- Вместимость -->
                                            <StackPanel Orientation="Horizontal" Margin="0,0,16,0">
                                                <materialDesign:PackIcon Kind="AccountMultiple"
                                                                        Width="16" Height="16"
                                                                        Foreground="#6B7280"
                                                                        VerticalAlignment="Center"
                                                                        Margin="0,0,6,0"/>
                                                <TextBlock VerticalAlignment="Center"
                                                          FontSize="14"
                                                          Foreground="#6B7280">
                                                    <Run Text="{Binding Capacity, Mode=OneWay}"/>
                                                    <Run Text="чел"/>
                                                </TextBlock>
                                            </StackPanel>

                                            <!-- Цена -->
                                            <StackPanel Orientation="Horizontal">
                                                <materialDesign:PackIcon Kind="CurrencyRub"
                                                                        Width="16" Height="16"
                                                                        Foreground="#059669"
                                                                        VerticalAlignment="Center"
                                                                        Margin="0,0,6,0"/>
                                                <TextBlock VerticalAlignment="Center"
                                                          FontSize="14"
                                                          FontWeight="SemiBold"
                                                          Foreground="#059669">
                                                    <Run Text="{Binding PricePerNight, StringFormat='{}{0:N0}', Mode=OneWay}"/>
                                                    <Run Text="₽/ночь"/>
                                                </TextBlock>
                                            </StackPanel>
                                        </StackPanel>

                                        <!-- Удобства (Amenities) -->
                                        <ItemsControl Grid.Row="3"
                                                     ItemsSource="{Binding AmenitiesList}">
                                            <ItemsControl.ItemsPanel>
                                                <ItemsPanelTemplate>
                                                    <WrapPanel Orientation="Horizontal"/>
                                                </ItemsPanelTemplate>
                                            </ItemsControl.ItemsPanel>
                                            <ItemsControl.ItemTemplate>
                                                <DataTemplate>
                                                    <Border Background="#F3F4F6"
                                                           BorderBrush="#E5E7EB"
                                                           BorderThickness="1"
                                                           CornerRadius="8"
                                                           Padding="8,4"
                                                           Margin="0,0,8,4">
                                                        <TextBlock Text="{Binding}"
                                                                  FontSize="12"
                                                                  Foreground="#374151"/>
                                                    </Border>
                                                </DataTemplate>
                                            </ItemsControl.ItemTemplate>
                                        </ItemsControl>
                                    </Grid>

                                    <!-- Triggers для визуального состояния -->
                                    <Border.Style>
                                        <Style TargetType="Border">
                                            <Style.Triggers>
                                                <!-- Hover эффект -->
                                                <Trigger Property="IsMouseOver" Value="True">
                                                    <Setter Property="BorderBrush" Value="#00897B"/>
                                                    <Setter Property="Effect">
                                                        <Setter.Value>
                                                            <DropShadowEffect BlurRadius="12" 
                                                                            ShadowDepth="0" 
                                                                            Color="#00897B" 
                                                                            Opacity="0.3"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                </Trigger>

                                                <!-- Выбранное состояние -->
                                                <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                                    <Setter Property="BorderBrush" Value="#00897B"/>
                                                    <Setter Property="Background" Value="#F0FDF4"/>
                                                    <Setter Property="Effect">
                                                        <Setter.Value>
                                                            <DropShadowEffect BlurRadius="16" 
                                                                            ShadowDepth="2" 
                                                                            Color="#00897B" 
                                                                            Opacity="0.4"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                    <Setter Property="RenderTransform">
                                                        <Setter.Value>
                                                            <ScaleTransform ScaleX="1.02" ScaleY="1.02"/>
                                                        </Setter.Value>
                                                    </Setter>
                                                </DataTrigger>
                                            </Style.Triggers>
                                        </Style>
                                    </Border.Style>
                                </Border>

                                <DataTemplate.Triggers>
                                    <!-- Показать badge "Выбран" -->
                                    <DataTrigger Binding="{Binding IsSelected}" Value="True">
                                        <Setter TargetName="SelectedBadge" Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </DataTemplate.Triggers>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </ScrollViewer>
            </Grid>
        </materialDesign:Card>

        <!-- ═══════════════════════════════════════════════════════════ -->
        <!-- ПРАВАЯ КОЛОНКА: ФОРМА БРОНИРОВАНИЯ -->
        <!-- ═══════════════════════════════════════════════════════════ -->
        <materialDesign:Card Grid.Column="2"
                            UniformCornerRadius="8"
                            materialDesign:ElevationAssist.Elevation="Dp4">
            <Grid>
                <Grid.RowDefinitions>
                    <RowDefinition Height="Auto"/>
                    <RowDefinition Height="*"/>
                </Grid.RowDefinitions>

                <!-- Заголовок формы -->
                <Border Grid.Row="0" Height="64" CornerRadius="8,8,0,0">
                    <Border.Background>
                        <LinearGradientBrush StartPoint="0,0.5" EndPoint="1,0.5">
                            <GradientStop Color="#2E7D32" Offset="0"/>
                            <GradientStop Color="#00897B" Offset="1"/>
                        </LinearGradientBrush>
                    </Border.Background>

                    <TextBlock Text="Форма бронирования" 
                              FontSize="20"
                              FontWeight="Medium"
                              Foreground="White"
                              VerticalAlignment="Center"
                              Margin="24,0"/>
                </Border>

                <!-- Тело формы -->
                <ScrollViewer Grid.Row="1" 
                             VerticalScrollBarVisibility="Auto">
                    <Border Padding="24">
                        <Border.Background>
                            <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                <GradientStop Color="#F0FDF4" Offset="0"/>
                                <GradientStop Color="#FFFFFF" Offset="1"/>
                            </LinearGradientBrush>
                        </Border.Background>

                        <StackPanel>
                            <!-- 1. Выбор домика (ВИДНО ВСЕМ) -->
                            <TextBlock Text="Выберите домик *" 
                                      FontSize="14" 
                                      Foreground="#424242" 
                                      Margin="0,0,0,8"/>
                            <ComboBox x:Name="CabinComboBox"
                                     Style="{StaticResource MaterialDesignOutlinedComboBox}"
                                     materialDesign:HintAssist.Hint="-- Выберите домик --"
                                     ItemsSource="{Binding Cabins}"
                                     SelectedItem="{Binding SelectedCabin, Mode=TwoWay}"
                                     DisplayMemberPath="Name"
                                     Height="48" 
                                     Margin="0,0,0,16"/>

                            <!-- 2. Информационный блок (если домик выбран) (ВИДНО ВСЕМ) -->
                            <Border Background="#F0FDF4"
                                   BorderBrush="#BBF7D0"
                                   BorderThickness="1"
                                   CornerRadius="8"
                                   Padding="10"
                                   Margin="0,0,0,16"
                                   Visibility="{Binding SelectedCabin, Converter={StaticResource NullToVisibilityConverter}}">
                                <StackPanel>
                                    <TextBlock Text="{Binding SelectedCabin.Name}"
                                              FontSize="14"
                                              FontWeight="SemiBold"
                                              Foreground="#374151"/>
                                    <TextBlock FontSize="14" Foreground="#374151">
                                        <Run Text="Вместимость:"/>
                                        <Run Text="{Binding SelectedCabin.MaxGuests, Mode=OneWay}"/>
                                        <Run Text="чел. •"/>
                                        <Run Text="{Binding SelectedCabin.PricePerNight, StringFormat='{}{0:N0}', Mode=OneWay}"/>
                                        <Run Text="₽/ночь"/>
                                    </TextBlock>
                                </StackPanel>
                            </Border>

                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <!-- ПОЛЯ ДЛЯ ADMIN И MANAGER (СКРЫТЫ ДЛЯ ГОСТЯ) -->
                            <!-- ═══════════════════════════════════════════════════════════ -->
                            <StackPanel Visibility="{Binding IsGuestMode, Converter={StaticResource InverseBoolToVisibilityConverter}}">

                                <!-- 3. ФИО гостя -->
                                <TextBlock Text="ФИО гостя *" 
                                          FontSize="14" 
                                          Foreground="#424242" 
                                          Margin="0,0,0,8"/>
                                <TextBox Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                        materialDesign:HintAssist.Hint="Иванов Иван Иванович"
                                        Text="{Binding GuestName, UpdateSourceTrigger=PropertyChanged}"
                                        Height="48" 
                                        Margin="0,0,0,16"/>

                                <!-- 4. Телефон -->
                                <TextBlock Text="Телефон *" 
                                          FontSize="14" 
                                          Foreground="#424242" 
                                          Margin="0,0,0,8"/>
                                <TextBox Style="{StaticResource MaterialDesignOutlinedTextBox}"
                                        materialDesign:HintAssist.Hint="+7 (999) 123-45-67"
                                        Text="{Binding GuestPhone, UpdateSourceTrigger=PropertyChanged}"
                                        Height="48" 
                                        Margin="0,0,0,16"/>
                                <!-- ✅ НОВОЕ: Email (опционально) -->
                                <TextBlock Text="Email (опционально)" FontSize="14" Foreground="#424242" Margin="0,0,0,8"/>
                                <TextBox x:Name="TxtGuestEmail"
    Style="{StaticResource MaterialDesignOutlinedTextBox}"
    materialDesign:HintAssist.Hint="gost@example.com"
    Text="{Binding GuestEmail, UpdateSourceTrigger=PropertyChanged}"
    Height="48" Margin="0,0,0,16"/>
                            </StackPanel>

                            <!-- 5. Даты заезда/выезда (ВИДНО ВСЕМ) -->
                            <Grid Margin="0,0,0,16">
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="*"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Дата заезда -->
                                <StackPanel Grid.Column="0">
                                    <TextBlock Text="Заезд *" 
                                              FontSize="14" 
                                              Foreground="#424242" 
                                              Margin="0,0,0,8"/>
                                    <DatePicker SelectedDate="{Binding CheckInDate, Mode=TwoWay}"
                                               Style="{StaticResource MaterialDesignOutlinedDatePicker}"
                                               Height="48"/>
                                </StackPanel>

                                <!-- Дата выезда -->
                                <StackPanel Grid.Column="2">
                                    <TextBlock Text="Выезд *" 
                                              FontSize="14" 
                                              Foreground="#424242" 
                                              Margin="0,0,0,8"/>
                                    <DatePicker SelectedDate="{Binding CheckOutDate, Mode=TwoWay}"
                                               Style="{StaticResource MaterialDesignOutlinedDatePicker}"
                                               Height="48"/>
                                </StackPanel>
                            </Grid>

                            <!-- 6. Блок итоговой стоимости (ВИДНО ВСЕМ) -->
                            <Border Background="{StaticResource PrimaryGradient}"
                                   CornerRadius="8"
                                   Padding="12"
                                   Margin="0,0,0,16"
                                   Visibility="{Binding ShowTotalPrice, Converter={StaticResource BoolToVisibilityConverter}}">

                                <StackPanel>
                                    <!-- Строка 1: Количество ночей -->
                                    <Grid Margin="0,0,0,8">
                                        <TextBlock Text="Количество ночей:"
                                                  FontSize="14"
                                                  Foreground="White"
                                                  VerticalAlignment="Center"/>
                                        <TextBlock Text="{Binding Nights}"
                                                  FontSize="14"
                                                  FontWeight="SemiBold"
                                                  Foreground="White"
                                                  HorizontalAlignment="Right"
                                                  VerticalAlignment="Center"/>
                                    </Grid>

                                    <!-- Разделитель -->
                                    <Border Height="1" 
                                           Background="White" 
                                           Opacity="0.3" 
                                           Margin="0,0,0,8"/>

                                    <!-- Строка 2: Итого -->
                                    <Grid>
                                        <TextBlock FontSize="14" 
                                                  Foreground="White"
                                                  VerticalAlignment="Center">
                                            <Run Text="Ночей:"/>
                                            <Run Text="{Binding Nights, Mode=OneWay}"/>
                                            <Run Text="•"/>
                                        </TextBlock>
                                        <TextBlock HorizontalAlignment="Right"
                                                  VerticalAlignment="Center"
                                                  Foreground="White">
                                            <Run Text="Итого:" FontSize="14"/>
                                            <Run Text="{Binding TotalPrice, StringFormat='{}{0:N0}', Mode=OneWay}" 
                                                FontSize="20" 
                                                FontWeight="Bold"/>
                                            <Run Text="₽" FontSize="14"/>
                                        </TextBlock>
                                    </Grid>
                                </StackPanel>
                            </Border>

                            <!-- 7. Кнопка "Создать бронирование" (СКРЫТА ДЛЯ ГОСТЯ) -->
                            <Button Command="{Binding CreateBookingCommand}"
                                   Height="40" 
                                   HorizontalAlignment="Stretch"
                                   Margin="0,16,0,0"
                                   Visibility="{Binding IsGuestMode, Converter={StaticResource InverseBoolToVisibilityConverter}}">
                                <Button.Style>
                                    <Style TargetType="Button" BasedOn="{StaticResource MaterialDesignRaisedButton}">
                                        <Setter Property="Background">
                                            <Setter.Value>
                                                <LinearGradientBrush StartPoint="0,0.5" EndPoint="1,0.5">
                                                    <GradientStop Color="#15803D" Offset="0"/>
                                                    <GradientStop Color="#059669" Offset="1"/>
                                                </LinearGradientBrush>
                                            </Setter.Value>
                                        </Setter>
                                        <Setter Property="Foreground" Value="White"/>
                                    </Style>
                                </Button.Style>
                                <TextBlock Text="Создать бронирование" 
                                          FontSize="14"
                                          FontWeight="Medium"/>
                            </Button>

                            <!-- 8. Информационное сообщение для ГОСТЯ (ВИДНО ТОЛЬКО ГОСТЮ) -->
                            <Border Background="#FEF3C7"
                                   BorderBrush="#FCD34D"
                                   BorderThickness="1"
                                   CornerRadius="8"
                                   Padding="16"
                                   Margin="0,16,0,0"
                                   Visibility="{Binding IsGuestMode, Converter={StaticResource BoolToVisibilityConverter}}">
                                <StackPanel>
                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,12">
                                        <materialDesign:PackIcon Kind="InformationOutline" 
                                                                Width="20" Height="20" 
                                                                Foreground="#92400E"
                                                                VerticalAlignment="Center"
                                                                Margin="0,0,8,0"/>
                                        <TextBlock Text="Гостевой режим" 
                                                  FontSize="15" 
                                                  FontWeight="SemiBold"
                                                  Foreground="#92400E"
                                                  VerticalAlignment="Center"/>
                                    </StackPanel>

                                    <TextBlock Text="Для создания бронирования обратитесь к администратору или менеджеру." 
                                              FontSize="13" 
                                              Foreground="#78350F"
                                              TextWrapping="Wrap"
                                              Margin="0,0,0,12"
                                              LineHeight="18"/>

                                    <Separator Background="#FCD34D" Margin="0,0,0,12"/>

                                    <TextBlock Text="📞 Контакты для связи:" 
                                              FontSize="13"
                                              FontWeight="SemiBold"
                                              Foreground="#92400E"
                                              Margin="0,0,0,8"/>

                                    <StackPanel Orientation="Horizontal" Margin="0,0,0,4">
                                        <materialDesign:PackIcon Kind="Phone" 
                                                                Width="16" Height="16" 
                                                                Foreground="#78350F"
                                                                VerticalAlignment="Center"
                                                                Margin="0,0,6,0"/>
                                        <TextBlock Text="+7 (999) 123-45-67" 
                                                  FontSize="13" 
                                                  FontWeight="Medium"
                                                  Foreground="#78350F"
                                                  VerticalAlignment="Center"/>
                                    </StackPanel>

                                    <StackPanel Orientation="Horizontal">
                                        <materialDesign:PackIcon Kind="Email" 
                                                                Width="16" Height="16" 
                                                                Foreground="#78350F"
                                                                VerticalAlignment="Center"
                                                                Margin="0,0,6,0"/>
                                        <TextBlock Text="info@lesnaya-usadba.ru" 
                                                  FontSize="13" 
                                                  FontWeight="Medium"
                                                  Foreground="#78350F"
                                                  VerticalAlignment="Center"/>
                                    </StackPanel>
                                </StackPanel>
                            </Border>

                        </StackPanel>
                    </Border>
                </ScrollViewer>
            </Grid>
        </materialDesign:Card>

        <!-- Snackbar для уведомлений -->
        <materialDesign:Snackbar x:Name="BookingSnackbar"
                                Grid.Column="0"
                                Grid.ColumnSpan="3"
                                MessageQueue="{materialDesign:MessageQueue}"/>
    </Grid>
</UserControl>